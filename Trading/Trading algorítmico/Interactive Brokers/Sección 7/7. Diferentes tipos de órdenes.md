### **Resumen: Tipos de Órdenes Avanzadas y Bracket Orders**

Esta lección profundiza en la ejecución de órdenes, mostrando cómo construir y enviar los tipos de órdenes más comunes utilizados en el trading. Además de las órdenes a Mercado (`MKT`) y Límite (`LMT`), se introducen las órdenes Stop (`STP`) y Stop-Límite (`STP LMT`).

El concepto más avanzado e importante es la creación de una **"Bracket Order" (Orden Horquilla)**. Esto consiste en enviar una orden de entrada principal (por ejemplo, una compra a mercado) y adjuntarle automáticamente dos órdenes de salida:
1.  Una orden **Take Profit** (Límite de Venta) para asegurar ganancias.
2.  Una orden **Stop Loss** (Stop de Venta) para limitar pérdidas.

Esto se logra vinculando las órdenes de salida a la principal mediante el atributo `parentId` y gestionando su envío con el atributo `transmit`.

***

### **El Bloque de Código Clave**

La implementación de la "Bracket Order" es la pieza de código más instructiva de esta lección. Muestra cómo se configuran tres órdenes separadas para que funcionen como un único grupo cohesivo, donde la ejecución de la orden principal activa las otras dos, y la ejecución de una de las salidas (Take Profit o Stop Loss) cancela automáticamente la otra.

```python
# Método para crear y enviar una orden de compra con Stop Loss y Take Profit adjuntos.
def ejecutar_orden_tk_sl(self, stop_loss_price, take_profit_price):
    
    contrato = self.crear_contrato()
    
    # 1. Crear Orden Principal (Entrada a Mercado)
    # transmit=False significa que la orden se envía a TWS pero no se transmite aún al mercado.
    market_order = Order()
    market_order.orderId = self.next_order_id + 4
    market_order.action = "BUY"
    market_order.orderType = "MKT"
    market_order.totalQuantity = 10
    market_order.eTradeOnly = ""
    market_order.firmQuoteOnly = ""
    market_order.transmit = False
    
    # 2. Crear Orden Stop Loss (Hija)
    # Se vincula a la orden principal con 'parentId'.
    stop_loss = Order()
    stop_loss.parentId = market_order.orderId
    stop_loss.orderId = market_order.orderId + 1
    stop_loss.action = "SELL"
    stop_loss.orderType = "STP"
    stop_loss.totalQuantity = 10
    stop_loss.auxPrice = stop_loss_price
    market_order.eTradeOnly = ""
    market_order.firmQuoteOnly = ""
    stop_loss.transmit = False
    
    # 3. Crear Orden Take Profit (Hija)
    # Se vincula también a la orden principal.
    # transmit=True en la ÚLTIMA orden del grupo envía el paquete completo.
    limit_order = Order()
    limit_order.parentId = market_order.orderId
    limit_order.orderId = market_order.orderId + 2
    limit_order.action = "SELL"
    limit_order.orderType = "LMT"
    limit_order.totalQuantity = 10
    limit_order.lmtPrice = take_profit_price
    market_order.eTradeOnly = ""
    market_order.firmQuoteOnly = ""
    limit_order.transmit = True # ¡Esta orden transmite todo el grupo!
    
    # Enviar las 3 órdenes a TWS.
    self.placeOrder(orderId=market_order.orderId, contract=contrato, 
    order=market_order)
    self.placeOrder(orderId=stop_loss.orderId, contract=contrato, 
    order=stop_loss)
    self.placeOrder(orderId=limit_order.orderId, contract=contrato, 
    order=limit_order)

# Flujo de trabajo: Conectar -> Ejecutar diferentes tipos de órdenes

# 1. Conectar a IB y obtener ID de orden (código estándar).
IB_con = IB_TiposOrdenes()
IB_con.connect(host="127.0.0.1", port=7497, clientId=10)
api_thread = threading.Thread(target=IB_con.run)
api_thread.start()
time.sleep(2)
    
# 2. Ejecutar una orden Stop-Límite llamando al método específico.
print("--> Ejecutando Orden Stop-Límite...")
IB_con.ejecutar_orden_stop_limit(precio=240.03, precio_auxiliar=240)
time.sleep(3)
    
# 3. Incrementar el ID para la siguiente orden.
IB_con.next_order_id += 4 # Se ajusta el contador de IDs.

# 4. Ejecutar la Bracket Order (compra con Take Profit y Stop Loss).
print("\n--> Ejecutando Bracket Order (TP y SL)...")
IB_con.ejecutar_orden_tk_sl(stop_loss_price=230, take_profit_price=250)
time.sleep(3)

# 5. Desconectar.
IB_con.disconnect()
api_thread.join()